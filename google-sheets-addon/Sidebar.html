<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Find&Tell Charts</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f9fafb;
      overflow: hidden;
    }

    #loading {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: white;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
    }

    #loading.visible {
      display: flex;
    }

    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #06b6d4;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: #6b7280;
      font-size: 14px;
    }

    #error {
      display: none;
      padding: 20px;
      background: white;
      height: 100vh;
    }

    #error.visible {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .error-icon {
      width: 48px;
      height: 48px;
      background: #fee2e2;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      color: #dc2626;
      font-size: 24px;
    }

    .error-title {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }

    .error-message {
      font-size: 14px;
      color: #6b7280;
      text-align: center;
      max-width: 300px;
      line-height: 1.5;
      margin-bottom: 16px;
    }

    .error-button {
      padding: 8px 16px;
      background: #06b6d4;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .error-button:hover {
      background: #0891b2;
    }

    iframe {
      width: 100%;
      height: 100vh;
      border: none;
      display: block;
      background: white;
    }
  </style>
</head>
<body>
  <!-- Loading State -->
  <div id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Loading Find&Tell Charts...</div>
  </div>

  <!-- Error State -->
  <div id="error">
    <div class="error-icon">âš </div>
    <div class="error-title">Unable to Load</div>
    <div class="error-message" id="error-message">
      An error occurred while loading the chart editor.
    </div>
    <button class="error-button" onclick="retryLoad()">Try Again</button>
  </div>

  <!-- Open in New Tab Button - Floating -->
  <div id="openInTabButton" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;">
    <button onclick="openInNewTab()" style="padding: 12px 24px; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4); transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(6, 182, 212, 0.5)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(6, 182, 212, 0.4)'">
      <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
      </svg>
      Open in Full Screen
    </button>
  </div>

  <!-- Main Chart App (iframe) -->
  <iframe
    id="chartApp"
    src="https://charts.findandtell.co?mode=addon"
    allow="clipboard-write"
  ></iframe>

  <script>
    // Configuration
    const IFRAME_LOAD_TIMEOUT = 10000; // 10 seconds
    let iframeLoadTimer = null;
    let iframeLoaded = false;

    // Elements
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const errorMessageEl = document.getElementById('error-message');
    const iframeEl = document.getElementById('chartApp');

    /**
     * Initialize the add-on
     */
    function init() {
      console.log('Initializing Find&Tell Charts add-on...');
      console.log('iframe src:', iframeEl.src);

      // Show "Open in New Tab" button immediately
      document.getElementById('openInTabButton').style.display = 'block';

      // Listen for iframe load
      iframeEl.addEventListener('load', function() {
        console.log('iframe load event fired');
        iframeLoaded = true;

        // Send initial configuration to the React app
        setTimeout(function() {
          sendMessageToApp({
            type: 'ADDON_READY',
            platform: 'google-sheets'
          });
        }, 100);
      });

      // Listen for messages from iframe
      window.addEventListener('message', handleMessage);

      // Get user info and license
      getUserInfoAndLicense();
    }

    /**
     * Handle iframe load event
     */
    function handleIframeLoad() {
      console.log('iframe loaded successfully');
      iframeLoaded = true;
      clearTimeout(iframeLoadTimer);

      // Hide loading immediately
      loadingEl.classList.add('hidden');
      iframeEl.classList.add('loaded');

      // Show "Open in New Tab" button
      document.getElementById('openInTabButton').style.display = 'block';

      // Send initial configuration to the React app
      // Use a small delay to ensure iframe is fully ready
      setTimeout(function() {
        sendMessageToApp({
          type: 'ADDON_READY',
          platform: 'google-sheets'
        });
      }, 100);
    }

    /**
     * Open chart editor in a new browser tab with selected data
     */
    function openInNewTab() {
      console.log('Opening chart editor in new tab');

      // Get selected data from the sheet
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.data && result.data.csv) {
            // Encode CSV data for URL
            const encodedCSV = encodeURIComponent(result.data.csv);

            // Open new tab with CSV data as URL parameter
            const url = `https://charts.findandtell.co?csv=${encodedCSV}`;
            window.open(url, '_blank');
          } else {
            alert('Please select data in your spreadsheet first.');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error getting sheet data:', error);
          alert('Error getting sheet data: ' + error.message);
        })
        .getSelectedData();
    }

    /**
     * Get user info and license from Apps Script
     */
    function getUserInfoAndLicense() {
      google.script.run
        .withSuccessHandler(function(userInfo) {
          console.log('User info retrieved:', userInfo);

          // Get license info
          google.script.run
            .withSuccessHandler(function(license) {
              console.log('License info retrieved:', license);

              // Send to React app
              sendMessageToApp({
                type: 'USER_INFO',
                data: {
                  user: userInfo.user,
                  license: license.license
                }
              });
            })
            .withFailureHandler(handleError)
            .checkLicense();
        })
        .withFailureHandler(handleError)
        .getUserInfo();
    }

    /**
     * Handle messages from the React app
     */
    function handleMessage(event) {
      // Security: Verify origin in production
      // if (event.origin !== 'https://charts.findandtell.co') {
      //   return;
      // }

      const message = event.data;
      console.log('Message received from app:', message);

      switch (message.type) {
        case 'REQUEST_DATA':
          getSheetData();
          break;

        case 'INSERT_CHART':
          insertChart(message.data);
          break;

        case 'LOG_USAGE':
          logUsage(message.action, message.metadata);
          break;

        case 'READY':
          console.log('React app is ready');
          break;

        default:
          console.log('Unknown message type:', message.type);
      }
    }

    /**
     * Get selected data from the sheet
     */
    function getSheetData() {
      console.log('Getting sheet data...');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            console.log('Sheet data retrieved:', result.data);

            sendMessageToApp({
              type: 'SHEET_DATA',
              data: result.data
            });
          } else {
            showError(result.error);
          }
        })
        .withFailureHandler(handleError)
        .getSelectedData();
    }

    /**
     * Insert chart into the sheet
     */
    function insertChart(chartData) {
      console.log('Inserting chart to sheet...');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            console.log('Chart inserted successfully with ID:', result.chartId);

            sendMessageToApp({
              type: 'INSERT_SUCCESS',
              message: result.message,
              chartId: result.chartId
            });
          } else {
            showError(result.error);
          }
        })
        .withFailureHandler(handleError)
        .insertChartToSheet(chartData.imageBase64, chartData.format, chartData.chartState);
    }

    /**
     * Log usage analytics
     */
    function logUsage(action, metadata) {
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('Usage logged:', action);
        })
        .withFailureHandler(function(error) {
          console.error('Failed to log usage:', error);
        })
        .logUsage(action, metadata);
    }

    /**
     * Send message to React app
     */
    function sendMessageToApp(message) {
      if (iframeEl && iframeEl.contentWindow) {
        iframeEl.contentWindow.postMessage(message, '*');
      }
    }

    /**
     * Handle errors
     */
    function handleError(error) {
      console.error('Error:', error);
      showError(error.message || 'An unexpected error occurred. Please try again.');
    }

    /**
     * Show error state
     */
    function showError(message) {
      loadingEl.classList.add('hidden');
      iframeEl.classList.remove('loaded');
      errorEl.classList.add('visible');
      errorMessageEl.textContent = message;
    }

    /**
     * Retry loading
     */
    function retryLoad() {
      errorEl.classList.remove('visible');
      loadingEl.classList.remove('hidden');
      location.reload();
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
